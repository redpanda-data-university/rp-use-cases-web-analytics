import { Hono } from 'hono'
import { cors } from 'hono/cors'

const app = new Hono()
app.use('*', cors())

app.get('/js', async (c) => {
  const baseUrl = new URL(c.req.url).hostname
  c.header('Content-Type', 'application/javascript');

  return c.text(`
    const payload = {
      url: window.location.href,
      path: new URL(window.location.href).pathname
    }
    fetch("https://${baseUrl}/track", {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then((response) => {
      // success handler
    });
  `)
});

app.post('/track', async (c) => {
// parse the payload that contains the page URL
  const { path, url } = await c.req.json()

  console.log(`Saw vistor at: ${path}`)
  return c.json({ success: true })
})

export default app